<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSC 설정 및 신호 보내기</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            margin: 0;
            height: 100vh;
            overflow: hidden; /* 스크롤 숨기기 */
        }
        .left-panel, .right-panel {
            padding: 10px;
            box-sizing: border-box;
        }
        .left-panel {
            width: 50%; /* 좌측 패널 너비 */
            border-right: 1px solid #ccc; /* 오른쪽 경계선 */
        }
        .right-panel {
            width: 50%; /* 우측 패널 너비 */
            display: flex;
            flex-direction: column;
            position: relative; /* 자식 요소의 절대 위치를 위해 */
        }
        h1, h2 {
            margin: 5px 0;
            font-size: 1rem; /* 제목 크기 */
        }
        input, button {
            margin: 3px 0;
            width: 70%; /* 입력 필드와 버튼의 너비 */
            padding: 8px;
            font-size: 0.9rem; /* 글자 크기 */
        }
        #messages {
            margin-top: 10px;
            flex-grow: 0.5; /* 가변 높이 설정 */
            border: 1px solid #ccc;
            padding: 5px;
            overflow-y: auto; /* 스크롤 가능 */
        }
        #emotionMapping {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 0.8rem; /* 작은 글자 크기 */
            background-color: rgba(212, 212, 212, 0.9); /* 배경 색상 */
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <h2>OSC 주소</h2>
        <input type="text" id="oscAddress" placeholder="주소 입력" />
        <input type="text" id="oscPort1" placeholder="포트 1 입력" />
        <input type="text" id="oscPort2" placeholder="포트 2 입력" />
        <button id="saveSettingsButton">설정 저장</button>

        <h2>OSC 신호 전송</h2>
        <input type="text" id="oscMsgAddress" placeholder="단일 신호" />
        <input type="text" id="loopMsgAddress" placeholder="반복 신호" />
        <input type="text" id="loopInterval" placeholder="간격 (ms)" />
        <button id="sendOscButtonPort1">포트 1 신호 보내기</button>
        <button id="sendOscButtonPort2">포트 2 신호 보내기</button>
        <button id="startLoopButton">반복 시작</button>
        <button id="stopLoopButton">반복 중지</button>
    </div>

    <div class="right-panel">
        <h1>소켓 통신 모니터링</h1>
        <div id="connectionStatus">WebSocket 연결 상태: 대기 중</div>
        <h2>갤럭시 탭 수신 메시지</h2>
        <div id="messages"></div>

        <!-- 감정과 숫자 매핑 표시 -->
        <div id="emotionMapping">
            <div>neutral 0</div>
            <div>angry 1</div>
            <div>disgusted 1</div>
            <div>fearful 2</div>
            <div>happy 3</div>
            <div>sad 4</div>
            <div>surprised 5</div>
        </div>
    </div>

    <script>
      // 웹소켓 클라이언트 설정
      const socket = new WebSocket('ws://localhost:3000'); // 서버 주소

      // 웹소켓이 열리면
      socket.addEventListener('open', () => {
          console.log('WebSocket 연결됨');
          updateConnectionStatus(true); // 연결 상태 업데이트
      });

      // 메시지를 수신했을 때
      socket.addEventListener('message', (event) => {
          console.log('메시지 수신:', event.data);
          displayMessage(event.data); // 수신한 메시지를 화면에 표시

          // 수신한 데이터가 0~5인 경우
          const receivedValue = parseInt(event.data, 10);
          if (receivedValue >= 0 && receivedValue <= 5) {
              // 로컬 서버로 동일한 숫자 전송
              sendToLocalServer(receivedValue); // 숫자로 전송
          }
      });

      // 로컬 서버로 데이터 전송 함수
      function sendToLocalServer(data) {
          const localSocket = new WebSocket('ws://localhost:3001'); // 로컬 서버 주소

          localSocket.addEventListener('open', () => {
              console.log('로컬 서버에 연결됨');
              localSocket.send(data.toString()); // 숫자를 문자열로 변환하여 전송
          });

          localSocket.addEventListener('message', (event) => {
              console.log('로컬 서버 응답:', event.data);
              localSocket.close(); // 작업이 끝난 후 소켓 닫기
          });

          localSocket.addEventListener('error', (error) => {
              console.error('로컬 서버 오류:', error);
          });
      }

      // 수신한 메시지를 화면에 표시하는 함수
      function displayMessage(message) {
          const messagesDiv = document.getElementById('messages');
          const messageElement = document.createElement('div');
          messageElement.textContent = message;
          messagesDiv.appendChild(messageElement);
      }

      // 연결 상태 업데이트 함수
      function updateConnectionStatus(isConnected) {
          const connectionStatus = document.getElementById('connectionStatus');
          connectionStatus.textContent = `WebSocket 연결 상태: ${isConnected ? '연결됨' : '연결 끊김'}`;
      }

      document.addEventListener("DOMContentLoaded", () => {
        // OSC 설정 관련 기능
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const oscAddressInput = document.getElementById('oscAddress');
        const oscPort1Input = document.getElementById('oscPort1');
        const oscPort2Input = document.getElementById('oscPort2');

        saveSettingsButton.addEventListener('click', () => {
          const oscAddress = oscAddressInput.value;
          const oscPort1 = oscPort1Input.value;
          const oscPort2 = oscPort2Input.value;

          if (oscAddress && oscPort1 && oscPort2) {
            console.log(`OSC 설정 저장: 주소=${oscAddress}, 포트1=${oscPort1}, 포트2=${oscPort2}`);
          } else {
            console.error("모든 필드를 입력하세요.");
          }
        });

        // 포트 1에 OSC 메시지 보내기
        const sendOscButtonPort1 = document.getElementById('sendOscButtonPort1');
        sendOscButtonPort1.addEventListener('click', () => {
          const oscMsgAddress = document.getElementById('oscMsgAddress').value;
          const oscPort1 = oscPort1Input.value;

          if (oscMsgAddress && oscPort1) {
            console.log(`포트 1에 OSC 메시지 전송: 주소=${oscMsgAddress}, 포트=${oscPort1}`);
            socket.send(JSON.stringify({ address: oscMsgAddress, port: oscPort1 })); // WebSocket으로 메시지 전송
          } else {
            console.error("OSC 메시지 주소와 포트 1을 입력하세요.");
          }
        });

        // 포트 2에 OSC 메시지 보내기
        const sendOscButtonPort2 = document.getElementById('sendOscButtonPort2');
        sendOscButtonPort2.addEventListener('click', () => {
          const oscMsgAddress = document.getElementById('oscMsgAddress').value;
          const oscPort2 = oscPort2Input.value;

          if (oscMsgAddress && oscPort2) {
            console.log(`포트 2에 OSC 메시지 전송: 주소=${oscMsgAddress}, 포트=${oscPort2}`);
            socket.send(JSON.stringify({ address: oscMsgAddress, port: oscPort2 })); // WebSocket으로 메시지 전송
          } else {
            console.error("OSC 메시지 주소와 포트 2를 입력하세요.");
          }
        });

        // 반복 신호 시작 버튼
        const startLoopButton = document.getElementById('startLoopButton');
        const stopLoopButton = document.getElementById('stopLoopButton');

        startLoopButton.addEventListener('click', () => {
          const loopMsgAddress = document.getElementById('loopMsgAddress').value;
          const loopInterval = parseInt(document.getElementById('loopInterval').value, 10);

          if (loopMsgAddress && loopInterval) {
            console.log(`반복 신호 시작: 주소=${loopMsgAddress}, 간격=${loopInterval}`);
            // 반복 전송 로직 추가 가능
          } else {
            console.error("반복 메시지 주소와 간격을 입력하세요.");
          }
        });

        stopLoopButton.addEventListener('click', () => {
          console.log("반복 OSC 신호 중지");
          // 반복 중지 로직 추가 가능
        });
      });
    </script>
</body>
</html>
